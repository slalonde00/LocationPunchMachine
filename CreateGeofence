import * as Location from 'expo-location';
import * as TaskManager from 'expo-task-manager';

const GEOFENCE_TASK_NAME = 'CHECK_IN_OUT_TASK';

// 1. Définir la tâche qui s'exécute en arrière-plan
TaskManager.defineTask(GEOFENCE_TASK_NAME, ({ data: { eventType, region }, error }) => {
  if (error) return;

  if (eventType === Location.GeofencingEventType.Enter) {
    console.log("Entrée dans le bureau : Pointage In");
    // Appel API vers votre serveur : fetch('https://api.votre-bureau.com', { method: 'POST', body: JSON.stringify({ userId: 123 }) });
  } else if (eventType === Location.GeofencingEventType.Exit) {
    console.log("Sortie du bureau : Pointage Out");
    // Appel API vers votre serveur : fetch('https://api.votre-bureau.com', ...);
  }
});

// 2. Initialiser la surveillance de la zone
export const setupGeofence = async () => {
  const { status } = await Location.requestBackgroundPermissionsAsync();
  if (status !== 'granted') return;

  await Location.startGeofencingAsync(GEOFENCE_TASK_NAME, [
    {
      identifier: 'Bureau_Principal',
      latitude: 45.5017, // Coordonnées de votre bureau
      longitude: -73.5673,
      radius: 50, // Rayon en mètres
      notifyOnEnter: true,
      notifyOnExit: true,
    },
  ]);
};
